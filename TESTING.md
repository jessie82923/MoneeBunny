# æ¸¬è©¦æŒ‡å—

æœ¬æ–‡ä»¶èªªæ˜å¦‚ä½•è¨­ç½®å’ŒåŸ·è¡Œ MoneeBunny API æ¸¬è©¦ã€‚

## ğŸ“‹ ç›®éŒ„

- [å¿«é€Ÿé–‹å§‹](#å¿«é€Ÿé–‹å§‹)
- [æ¸¬è©¦æ¶æ§‹](#æ¸¬è©¦æ¶æ§‹)
- [åŸ·è¡Œæ¸¬è©¦](#åŸ·è¡Œæ¸¬è©¦)
- [æ¸¬è©¦è³‡æ–™åº«è¨­å®š](#æ¸¬è©¦è³‡æ–™åº«è¨­å®š)
- [æ¸¬è©¦æª”æ¡ˆèªªæ˜](#æ¸¬è©¦æª”æ¡ˆèªªæ˜)
- [å¸¸è¦‹å•é¡Œ](#å¸¸è¦‹å•é¡Œ)

## ğŸš€ å¿«é€Ÿé–‹å§‹

### 1. å®‰è£æ¸¬è©¦å¥—ä»¶

æ¸¬è©¦å¥—ä»¶å·²ç¶“åŒ…å«åœ¨ `package.json` çš„ `devDependencies` ä¸­ï¼š

```bash
npm install
```

### 2. è¨­å®šæ¸¬è©¦è³‡æ–™åº«

```bash
# å»ºç«‹æ¸¬è©¦è³‡æ–™åº«
createdb moneebunny_test

# è¨­å®šç’°å¢ƒè®Šæ•¸ï¼ˆæˆ–åœ¨ .env æª”æ¡ˆä¸­è¨­å®šï¼‰
export DATABASE_URL="postgresql://username:password@localhost:5432/moneebunny_test"

# åŸ·è¡Œè³‡æ–™åº«é·ç§»
npx prisma migrate deploy
```

### 3. åŸ·è¡Œæ¸¬è©¦

```bash
npm test
```

## ğŸ—ï¸ æ¸¬è©¦æ¶æ§‹

### ä½¿ç”¨çš„æ¸¬è©¦å·¥å…·

- **Jest**: JavaScript æ¸¬è©¦æ¡†æ¶
- **ts-jest**: TypeScript æ”¯æ´
- **Supertest**: HTTP æ¸¬è©¦å·¥å…·
- **Prisma**: è³‡æ–™åº« ORM

### æ¸¬è©¦ç›®éŒ„çµæ§‹

```
tests/
â”œâ”€â”€ setup.ts                    # Jest å…¨åŸŸè¨­å®š
â””â”€â”€ api/
    â”œâ”€â”€ README.md              # API æ¸¬è©¦èªªæ˜
    â”œâ”€â”€ 01-auth.test.ts        # èªè­‰æ¸¬è©¦
    â”œâ”€â”€ 02-budgets.test.ts     # é ç®—æ¸¬è©¦
    â”œâ”€â”€ 03-transactions.test.ts # äº¤æ˜“æ¸¬è©¦
    â””â”€â”€ 04-integration.test.ts  # æ•´åˆæ¸¬è©¦
```

## ğŸ§ª åŸ·è¡Œæ¸¬è©¦

### åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦

```bash
npm test
```

### åŸ·è¡Œç‰¹å®šæ¸¬è©¦æª”æ¡ˆ

```bash
npm test 01-auth
# æˆ–
npm test auth.test.ts
```

### Watch æ¨¡å¼ï¼ˆé–‹ç™¼æ™‚ä½¿ç”¨ï¼‰

```bash
npm run test:watch
```

### ç”¢ç”Ÿæ¸¬è©¦è¦†è“‹ç‡å ±å‘Š

```bash
npm run test:coverage
```

æ¸¬è©¦è¦†è“‹ç‡å ±å‘Šæœƒç”¢ç”Ÿåœ¨ `coverage/` ç›®éŒ„ä¸­ã€‚

### åŸ·è¡Œç‰¹å®šæ¸¬è©¦æ¡ˆä¾‹

```bash
npm test -- -t "should register a new user"
```

## ğŸ—„ï¸ æ¸¬è©¦è³‡æ–™åº«è¨­å®š

### æ–¹æ³• 1: ä½¿ç”¨ç¨ç«‹çš„æ¸¬è©¦è³‡æ–™åº«ï¼ˆæ¨è–¦ï¼‰

```bash
# å»ºç«‹æ¸¬è©¦è³‡æ–™åº«
createdb moneebunny_test

# åœ¨ .env æª”æ¡ˆä¸­è¨­å®šæ¸¬è©¦è³‡æ–™åº«
DATABASE_URL_TEST="postgresql://username:password@localhost:5432/moneebunny_test"
```

### æ–¹æ³• 2: ä½¿ç”¨ Docker

```bash
# å•Ÿå‹•æ¸¬è©¦è³‡æ–™åº«å®¹å™¨
docker run -d \
  --name moneebunny-test-db \
  -e POSTGRES_USER=testuser \
  -e POSTGRES_PASSWORD=testpass \
  -e POSTGRES_DB=moneebunny_test \
  -p 5433:5432 \
  postgres:16

# è¨­å®šç’°å¢ƒè®Šæ•¸
export DATABASE_URL="postgresql://testuser:testpass@localhost:5433/moneebunny_test"
```

### è³‡æ–™åº«é·ç§»

åœ¨åŸ·è¡Œæ¸¬è©¦å‰ï¼Œç¢ºä¿æ¸¬è©¦è³‡æ–™åº«å·²ç¶“åŸ·è¡Œé·ç§»ï¼š

```bash
DATABASE_URL="postgresql://..." npx prisma migrate deploy
# æˆ–
DATABASE_URL="postgresql://..." npx prisma db push
```

## ğŸ“ æ¸¬è©¦æª”æ¡ˆèªªæ˜

### 01-auth.test.ts - èªè­‰ API æ¸¬è©¦

æ¸¬è©¦ç”¨æˆ¶èªè­‰ç›¸é—œåŠŸèƒ½ï¼š

- âœ… ç”¨æˆ¶è¨»å†Šï¼ˆæˆåŠŸ/å¤±æ•—æƒ…å¢ƒï¼‰
- âœ… ç”¨æˆ¶ç™»å…¥ï¼ˆæ­£ç¢º/éŒ¯èª¤æ†‘è­‰ï¼‰
- âœ… JWT Token é©—è­‰
- âœ… å–å¾—å€‹äººè³‡æ–™
- âœ… æ›´æ–°å€‹äººè³‡æ–™

**æ¸¬è©¦é‡é»**ï¼š
- å¯†ç¢¼åŠ å¯†
- Token ç”Ÿæˆèˆ‡é©—è­‰
- éŒ¯èª¤è™•ç†ï¼ˆé‡è¤‡è¨»å†Šã€éŒ¯èª¤å¯†ç¢¼ç­‰ï¼‰

### 02-budgets.test.ts - é ç®—ç®¡ç†æ¸¬è©¦

æ¸¬è©¦é ç®— CRUD æ“ä½œï¼š

- âœ… å»ºç«‹é ç®—
- âœ… åˆ—å‡ºæ‰€æœ‰é ç®—
- âœ… æŸ¥çœ‹ç‰¹å®šé ç®—
- âœ… æ›´æ–°é ç®—
- âœ… åˆªé™¤é ç®—

**æ¸¬è©¦é‡é»**ï¼š
- èªè­‰æª¢æŸ¥ï¼ˆéœ€è¦ç™»å…¥æ‰èƒ½æ“ä½œï¼‰
- æ¬Šé™æª¢æŸ¥ï¼ˆåªèƒ½æ“ä½œè‡ªå·±çš„é ç®—ï¼‰
- è³‡æ–™é©—è­‰

### 03-transactions.test.ts - äº¤æ˜“è¨˜éŒ„æ¸¬è©¦

æ¸¬è©¦äº¤æ˜“ CRUD æ“ä½œï¼š

- âœ… å»ºç«‹äº¤æ˜“ï¼ˆæ”¯å‡º/æ”¶å…¥ï¼‰
- âœ… åˆ—å‡ºæ‰€æœ‰äº¤æ˜“
- âœ… æŸ¥çœ‹ç‰¹å®šäº¤æ˜“
- âœ… æ›´æ–°äº¤æ˜“
- âœ… åˆªé™¤äº¤æ˜“

**æ¸¬è©¦é‡é»**ï¼š
- äº¤æ˜“èˆ‡é ç®—çš„é—œè¯
- äº¤æ˜“é¡å‹é©—è­‰ï¼ˆexpense/incomeï¼‰
- é‡‘é¡è¨ˆç®—æ­£ç¢ºæ€§

### 04-integration.test.ts - å®Œæ•´æµç¨‹æ¸¬è©¦

æ¨¡æ“¬çœŸå¯¦ç”¨æˆ¶ä½¿ç”¨æƒ…å¢ƒï¼š

1. ğŸ“ è¨»å†Šæ–°å¸³è™Ÿ
2. ğŸ” ç™»å…¥å–å¾— token
3. ğŸ’° å»ºç«‹æ¯æœˆé ç®—
4. ğŸ“Š æŸ¥çœ‹é ç®—åˆ—è¡¨
5. ğŸ’¸ æ–°å¢æ”¯å‡ºäº¤æ˜“
6. ğŸ’µ æ–°å¢æ”¶å…¥äº¤æ˜“
7. ğŸ“‹ æŸ¥çœ‹äº¤æ˜“åˆ—è¡¨
8. ğŸ” æŸ¥çœ‹ç‰¹å®šäº¤æ˜“è©³æƒ…
9. âœï¸ æ›´æ–°äº¤æ˜“è³‡è¨Š
10. ğŸ‘¤ æŸ¥çœ‹å€‹äººè³‡æ–™
11. ğŸ”„ æ›´æ–°å€‹äººè³‡æ–™

**æ¸¬è©¦é‡é»**ï¼š
- å®Œæ•´çš„ç”¨æˆ¶é«”é©—æµç¨‹
- API ä¹‹é–“çš„å”åŒé‹ä½œ
- è³‡æ–™ä¸€è‡´æ€§

## ğŸ”§ æ¸¬è©¦é…ç½®

### jest.config.js

Jest é…ç½®æª”æ¡ˆï¼Œå®šç¾©æ¸¬è©¦ç’°å¢ƒå’Œè¨­å®šï¼š

```javascript
module.exports = {
  preset: 'ts-jest',              // ä½¿ç”¨ ts-jest
  testEnvironment: 'node',        // Node.js ç’°å¢ƒ
  roots: ['<rootDir>/tests'],     // æ¸¬è©¦æª”æ¡ˆä½ç½®
  testMatch: ['**/*.test.ts'],    // æ¸¬è©¦æª”æ¡ˆæ¨¡å¼
  setupFilesAfterEnv: ['<rootDir>/tests/setup.ts'],  // å…¨åŸŸè¨­å®š
};
```

### tests/setup.ts

Jest å…¨åŸŸè¨­å®šæª”æ¡ˆï¼š

- è¨­å®š `NODE_ENV=test`
- è¨­å®šæ¸¬è©¦ç”¨çš„ JWT_SECRET
- è¨­å®šæ¸¬è©¦é€¾æ™‚æ™‚é–“ï¼ˆ30ç§’ï¼‰
- å¯é¸ï¼šæŠ‘åˆ¶æ¸¬è©¦æœŸé–“çš„ console è¼¸å‡º

## â“ å¸¸è¦‹å•é¡Œ

### Q: æ¸¬è©¦å¤±æ•—ï¼Œå‡ºç¾è³‡æ–™åº«é€£ç·šéŒ¯èª¤ï¼Ÿ

**A:** ç¢ºèªä»¥ä¸‹äº‹é …ï¼š
1. PostgreSQL æœå‹™æ˜¯å¦æ­£åœ¨åŸ·è¡Œ
2. `.env` æª”æ¡ˆä¸­çš„ `DATABASE_URL` æ˜¯å¦æ­£ç¢º
3. æ¸¬è©¦è³‡æ–™åº«æ˜¯å¦å·²å»ºç«‹
4. æ˜¯å¦å·²åŸ·è¡Œè³‡æ–™åº«é·ç§»

### Q: æ¸¬è©¦é€šéä½†å‡ºç¾å¾ˆå¤š console.log è¼¸å‡ºï¼Ÿ

**A:** å¯ä»¥åœ¨ `tests/setup.ts` ä¸­å–æ¶ˆè¨»è§£ä»¥ä¸‹è¡Œä¾†æŠ‘åˆ¶è¼¸å‡ºï¼š

```typescript
global.console = {
  ...console,
  log: jest.fn(),
  error: jest.fn(),
};
```

### Q: å¦‚ä½•æ¸¬è©¦ç‰¹å®šçš„ API ç«¯é»ï¼Ÿ

**A:** ä½¿ç”¨ Jest çš„ `-t` åƒæ•¸ï¼š

```bash
npm test -- -t "should create a new budget"
```

### Q: æ¸¬è©¦è³‡æ–™æœƒæ±¡æŸ“é–‹ç™¼è³‡æ–™åº«å—ï¼Ÿ

**A:** ä¸æœƒï¼Œåªè¦ä½¿ç”¨ç¨ç«‹çš„æ¸¬è©¦è³‡æ–™åº«ã€‚å»ºè­°è¨­å®šï¼š
- é–‹ç™¼è³‡æ–™åº«: `moneebunny`
- æ¸¬è©¦è³‡æ–™åº«: `moneebunny_test`

### Q: å¦‚ä½•æ¸…ç†æ¸¬è©¦è³‡æ–™ï¼Ÿ

**A:** å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ï¼š

```bash
# æ–¹æ³• 1: é‡å»ºæ¸¬è©¦è³‡æ–™åº«
dropdb moneebunny_test
createdb moneebunny_test
DATABASE_URL="..." npx prisma migrate deploy

# æ–¹æ³• 2: ä½¿ç”¨ Prisma Studio æ‰‹å‹•æ¸…ç†
DATABASE_URL="..." npx prisma studio
```

### Q: æ¸¬è©¦åŸ·è¡Œå¾ˆæ…¢ï¼Ÿ

**A:** å¯èƒ½çš„åŸå› å’Œè§£æ±ºæ–¹æ¡ˆï¼š
1. è³‡æ–™åº«é€£ç·šé€Ÿåº¦ï¼šä½¿ç”¨æœ¬åœ°è³‡æ–™åº«
2. æ¸¬è©¦é€¾æ™‚è¨­å®šï¼šèª¿æ•´ `jest.setTimeout()`
3. æ¸¬è©¦éš”é›¢ï¼šç¢ºä¿æ¸¬è©¦ä¸æœƒäº’ç›¸ç­‰å¾…

## ğŸ“š é€²éšç”¨æ³•

### ä½¿ç”¨æ¸¬è©¦è¦†è“‹ç‡

```bash
npm run test:coverage
```

è¦†è“‹ç‡å ±å‘Šæœƒé¡¯ç¤ºï¼š
- **Statements**: ç¨‹å¼ç¢¼é™³è¿°åŸ·è¡Œç‡
- **Branches**: åˆ†æ”¯åŸ·è¡Œç‡
- **Functions**: å‡½å¼åŸ·è¡Œç‡
- **Lines**: ç¨‹å¼ç¢¼è¡ŒåŸ·è¡Œç‡

### æ¸¬è©¦ç‰¹å®šæ¨¡çµ„

```bash
# åªæ¸¬è©¦èªè­‰ç›¸é—œ
npm test auth

# åªæ¸¬è©¦é ç®—ç›¸é—œ
npm test budgets

# åªæ¸¬è©¦æ•´åˆæ¸¬è©¦
npm test integration
```

### Debug æ¸¬è©¦

ä½¿ç”¨ VS Code çš„åµéŒ¯åŠŸèƒ½ï¼š

1. è¨­å®šä¸­æ–·é»
2. æŒ‰ F5 æˆ–ä½¿ç”¨ Debug é¢æ¿
3. é¸æ“‡ "Jest" é…ç½®

æˆ–ä½¿ç”¨ Node.js inspectï¼š

```bash
node --inspect-brk node_modules/.bin/jest --runInBand
```

## ğŸ¯ æœ€ä½³å¯¦è¸

1. **æ¸¬è©¦éš”é›¢**: æ¯å€‹æ¸¬è©¦æ‡‰è©²ç¨ç«‹é‹è¡Œ
2. **æ¸…ç†è³‡æº**: ä½¿ç”¨ `afterAll()` æ¸…ç†æ¸¬è©¦è³‡æ–™
3. **æœ‰æ„ç¾©çš„æ¸¬è©¦åç¨±**: ä½¿ç”¨æè¿°æ€§çš„æ¸¬è©¦åç¨±
4. **æ¸¬è©¦é‚Šç•Œæ¢ä»¶**: æ¸¬è©¦æ­£å¸¸æƒ…æ³å’Œç•°å¸¸æƒ…æ³
5. **ä½¿ç”¨ beforeAll/afterAll**: è¨­å®šå’Œæ¸…ç†å…±ç”¨è³‡æº
6. **é¿å…ç¡¬ç·¨ç¢¼**: ä½¿ç”¨è®Šæ•¸å’Œå¸¸æ•¸
7. **æ¸¬è©¦è¦†è“‹ç‡**: ç›®æ¨™è‡³å°‘ 80% è¦†è“‹ç‡

## ğŸ“– å»¶ä¼¸é–±è®€

- [Jest å®˜æ–¹æ–‡ä»¶](https://jestjs.io/docs/getting-started)
- [Supertest GitHub](https://github.com/visionmedia/supertest)
- [Prisma æ¸¬è©¦æŒ‡å—](https://www.prisma.io/docs/guides/testing)
- [TypeScript Jest é…ç½®](https://kulshekhar.github.io/ts-jest/)
